#!/bin/bash
#--------------------------------------------
# ðŸš€ Hyperf Watch Scripts
# ðŸš— Make Happy to Coding
# ðŸ‘‰ å¿«ä¹çš„çƒ­æ›´æ–°å·¥å…·ï¼Œç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯Hyperf

# Base on fswatch @ https://github.com/emcrisostomo/fswatch
# Author: hanicc@qq.com
# Version: 20190730@beta1
#
# ç”¨æ³•ç¤ºä¾‹:
# æŠŠwatchæ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸Š
# å¦‚æžœæ²¡æœ‰å®‰è£…fswatchï¼Œå…ˆå®‰è£…fswatchï¼š
# MacOSç”¨æˆ·: brew install fswatch
# Linuxç”¨æˆ·: è‡ªè¡Œç¼–è¯‘å®‰è£…fswatch
# Dockerç”¨æˆ·: éƒ½ä¼šç”¨Dockeräº†ï¼Œä½ åº”è¯¥çŸ¥é“æ€Žä¹ˆåš
# èµ‹äºˆè„šæœ¬æƒé™ï¼š
# chmod +x ./watch
# æ‰§è¡Œç›‘å¬ç¨‹åºï¼š
# ./watch
# æ‰§è¡Œç›‘å¬ç¨‹åºå¹¶æ¸…é™¤ç›‘å¬æ—¥å¿—:
# ./watch -c
# é€€å‡ºç›‘å¬ç¨‹åºï¼š
# Control + C
# å…¶å®ƒè¯´æ˜Žï¼š
# ç›‘å¬æ—¥å¿—/æŽ§åˆ¶å°æ—¥å¿—åœ¨./runtime/watch.log
# é€€å‡ºç›‘å¬ç¨‹åºä¼šåœ¨æŽ§åˆ¶å°æ‰“å°ç›‘å¬æ—¥å¿—ï¼Œæ–¹ä¾¿debug
# è„šæœ¬é»˜è®¤ç›‘å¬æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œä¸”åªç›‘å¬æ–‡ä»¶åŽç¼€ä¸º.phpæˆ–.env
# å¦‚æžœä½ å¸Œæœ›åªç›‘å¬æŸä¸ªæ–‡ä»¶å¤¹ï¼Œè¯·ä¿®æ”¹ä¸‹é¢çš„å˜é‡DIR
#--------------------------------------------

# ç›‘å¬ç›®å½•
DIR=./
# ç¨‹åºæ–‡ä»¶è·¯å¾„
BIN=./bin/hyperf.php
# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG=./runtime/watch.log
# fswatchå‘½ä»¤è·¯å¾„
WATCH=fswatch
# æŒ‡ä»¤ç¬¬ä¸€ä¸ªå˜é‡
CMD=$1

if [[ ${CMD} = "-c" ]]
    then
    rm ${LOG}
    echo -e "ðŸµ Clean ${LOG} success!"
fi

ps -ef | grep php\ ${BIN}\ start | grep -v grep | awk '{print $2}' | xargs kill

echo -e "ðŸš€ Start @ $(date "+%Y-%m-%d %H:%M:%S")"
echo -e "\n ================ \n ðŸš€ Start @ $(date "+%Y-%m-%d %H:%M:%S")\n ================ \n" >> ./runtime/watch.log

nohup php ${BIN} start >> ${LOG} &

${WATCH} ${DIR} | while read file
do
    EXT=${file##*.}
    if [[ ${EXT} = "php" || ${EXT} = "env" ]]
       then
       ps -ef | grep php\ ${BIN}\ start | grep -v grep | awk '{print $2}' | xargs kill
       echo -e "\n ================ \n ðŸ”„ Restart @ $(date "+%Y-%m-%d %H:%M:%S")\n ðŸ‘‰ ${file} was modified\n ================ \n" >> ./runtime/watch.log
       nohup php ${BIN} start >> ${LOG} &
       echo "ðŸ”„ Restart @ $(date "+%Y-%m-%d %H:%M:%S")"
     fi
done

cat ${LOG}