#!/bin/bash
#--------------------------------------------
# ðŸš€ Hyperf Watch Scripts
# ðŸš— Make Happy to Coding
# ðŸ‘‰ å¿«ä¹çš„çƒ­æ›´æ–°å·¥å…·ï¼Œç›‘å¬æ–‡ä»¶å˜åŒ–è‡ªåŠ¨é‡å¯Hyperf
# Author: hanicc@qq.com
# Version: 20190730@beta2
# GitHub: https://github.com/ha-ni-cc/hyperf-watch
#--------------------------------------------

# ç›‘å¬ç›®å½•
DIR=./
# ç¨‹åºæ–‡ä»¶è·¯å¾„
BIN=./bin/hyperf.php
# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG=./runtime/watch.log
# fswatchå‘½ä»¤è·¯å¾„
WATCH=fswatch
# æŒ‡ä»¤ç¬¬ä¸€ä¸ªå˜é‡
CMD=$1

#æ£€æŸ¥fswatchæ‰©å±•å­˜ä¸å­˜åœ¨
command -v ${WATCH} >/dev/null 2>&1 || { echo >&2 "[x] è¯·å…ˆå®‰è£…fswatchæ‰©å±•"; exit 1;}

if [[ ${CMD} = "-c" ]]
    then
    rm ${LOG}
    echo -e "ðŸµ Clean ${LOG} success!"
fi

ps -ef | grep php\ ${BIN}\ start | grep -v grep | awk '{print $2}' | xargs kill

echo -e "ðŸš€ Start @ $(date "+%Y-%m-%d %H:%M:%S")"
echo -e "\n ================ \n ðŸš€ Start @ $(date "+%Y-%m-%d %H:%M:%S")\n ================ \n" >> ./runtime/watch.log

nohup php ${BIN} start >> ${LOG} &

${WATCH} ${DIR} | while read file
do
    EXT=${file##*.}
    if [[ ${EXT} = "php" || ${EXT} = "env" ]]
       then
       ps -ef | grep php\ ${BIN}\ start | grep -v grep | awk '{print $2}' | xargs kill
       echo -e "\n ================ \n ðŸ”„ Restart @ $(date "+%Y-%m-%d %H:%M:%S")\n ðŸ‘‰ ${file} was modified\n ================ \n" >> ./runtime/watch.log
       nohup php ${BIN} start >> ${LOG} &
       echo "ðŸ”„ Restart @ $(date "+%Y-%m-%d %H:%M:%S")"
     fi
done

cat ${LOG}
